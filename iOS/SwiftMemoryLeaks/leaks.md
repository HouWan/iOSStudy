## å‰è¨€
å£°æ˜ï¼šæœ¬æ–‡éåŸåˆ›ï¼Œæ˜¯æˆ‘ç¿»è¯‘æ–‡ç« ã€‚æ„Ÿè°¢ä½œè€…`Kenny Dubroff`ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ã€‚

åŸæ–‡é“¾æ¥ï¼šhttps://blog.devgenius.io/unit-testing-memory-leaks-265f8d9777fb
åŸæ–‡ä½œè€…ï¼š`Kenny Dubroff`

## æ­£æ–‡

åœ¨ Swift ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ ARC éå¸¸é«˜æ•ˆåœ°å¤„ç†å†…å­˜ã€‚åŸºæœ¬ä¸Šï¼Œå¼•ç”¨å¯¹è±¡ï¼ˆä¾‹å¦‚ç±»`class`ï¼‰ä¼šè®°å½•å®ƒä»¬è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ã€‚å½“è®¡æ•°è¾¾åˆ° 0 æ—¶ï¼Œè¯¥å¯¹è±¡è¢«æ ‡è®°ä¸ºé‡Šæ”¾ï¼Œå¹¶åœ¨ç³»ç»Ÿéœ€è¦ç©ºé—´æ—¶ä»å†…å­˜ä¸­ç§»é™¤ã€‚

å¦‚æœæˆ‘ä»¬ä¸å°å¿ƒï¼Œæ¯”å¦‚åˆ›å»ºäº†ä¸€ä¸ªå¼•ç”¨å¾ªç¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šé‡åˆ°å†…å­˜ç©ºé—´æ°¸è¿œä¸ä¼šè¢«æ ‡è®°ä¸ºé‡Šæ”¾çš„æƒ…å†µã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œè¿½è¸ªè¿™äº›å¯èƒ½éå¸¸æ£˜æ‰‹ã€‚

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæ‚¨å°†å®ç°ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼Œå®ƒå¯ä»¥æµ‹è¯•ä»»ä½•å¯¹è±¡ç”¨äºæŸ¥çœ‹å®ƒæ˜¯å¦è¢«æ­£ç¡®åœ°é‡Šæ”¾ã€‚

æœ‰å…³å†…å­˜ç®¡ç†ã€å¾ªç¯å¼•ç”¨ä»¥åŠå¦‚ä½•é¿å…å®ƒä»¬çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š

[Swiftå¾ªç¯å¼•ç”¨ä¹‹Weakå’ŒUnowned](https://blog.devgenius.io/retain-cycles-and-weak-vs-unowned-643c676821fc)

### å¸¸è§çš„å¾ªç¯å¼•ç”¨

ä¸€ä¸ªå¸¸è§å¾ªç¯å¼•ç”¨çš„åœ°æ–¹å°±æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨é—­åŒ…(closure)ä¸­æ•è·`self`ã€‚æœ¬è´¨ä¸Šï¼Œ`self`æŒæœ‰é—­åŒ…ï¼Œé‚£ä¹ˆå¦‚æœé—­åŒ…å†…è°ƒç”¨`self`ï¼Œåˆ™é—­åŒ…å…·æœ‰å¯¹`self`çš„å¼•ç”¨ã€‚ä»–ä»¬äº’ç›¸æŒ‡ç€å¯¹æ–¹ï¼Œæ‰€ä»¥å¾ˆæœ‰å¯èƒ½ä»–ä»¬éƒ½ä¸ä¼šè¢«é‡Šæ”¾ã€‚

åˆ›å»ºä¸€ä¸ªåŒ…å«å•å…ƒæµ‹è¯•çš„æ–°é¡¹ç›®ï¼Œä½ å¯ä»¥ä½¿ç”¨é»˜è®¤çš„`ViewController`æˆ–è€…åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„ï¼Œæˆ‘ä»¬å‡†å¤‡å¼€å§‹å†™ä»£ç ã€‚

**æˆ‘æ˜¯å›¾ç‰‡002**
**æˆ‘æ˜¯å›¾ç‰‡002**

åœ¨`ViewController`ä¸­ï¼Œå®šä¸€ä¸ªé—­åŒ…ï¼Œå¹¶åœ¨é—­åŒ…çš„å®ç°ä¸­è¿›è¡Œæ•´æ•°ç›¸åŠ æ“ä½œã€‚æ³¨æ„ç¡®ä¿å®ç°æ‰€éœ€çš„`init`åˆå§‹åŒ–ã€‚

```swift
class ViewController: UIViewController {

    var numberOfTimes = 0

    private var closure: (() -> Void) = { }

    init() {
        super.init(nibName: nil, bundle: nil)
        commonInit()
    }

    required init?(coder: NSCoder) {
        super.init(coder: coder)
        commonInit()
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        countIt()
    }

    func commonInit() {
        self.closure = {
            self.numberOfTimes += 1
            print(self.numberOfTimes)
        }
    }

    func countIt() {
        closure()
    }
}
```

åœ¨é—­åŒ…ä¸­ï¼Œå¦‚æœä½ åœ¨`numberOfTimes`ä¹‹å‰æ²¡æœ‰åŠ `self.`ï¼Œç¼–è¯‘å™¨ä¼šç»™ä½ ä¸€ä¸ªå…³äºæ•è·è¯­ä¹‰çš„é”™è¯¯ã€‚ç¼–è¯‘å™¨éœ€è¦è®©æ‚¨åœ¨æ­¤å¤„æ˜¾ç¤ºå£°æ˜å¼•ç”¨å¯¹è±¡ï¼Œå¹¶æé†’æ‚¨å¯èƒ½åœ¨åˆ›å»ºä¸€ä¸ªå¾ªç¯å¼•ç”¨ã€‚åœ¨è¿™é‡Œæ‰“ç ´å¾ªç¯å¼•ç”¨æ˜¯å¾ˆå®¹æ˜“çš„äº‹æƒ…ï¼Œæˆ‘ä»¬å°†åœ¨æ–‡æœ¬åé¢ä»‹ç»ã€‚ä½†æ˜¯ç°åœ¨ï¼Œæˆ‘ä»¬æ•…æ„äº§ç”Ÿå†…å­˜æ³„æ¼ğŸ’§ã€‚

**è®©æˆ‘ä»¬å¼€å§‹è¯æ˜è¿™é‡Œæœ‰å¾ªç¯å¼•ç”¨**

æ‰“å¼€`YourProjectNameTests.swift`ï¼Œä½ ä¼šçœ‹åˆ°ä¸€äº›æ¨¡æ¿ä»£ç ï¼Œåˆ é™¤è¿™äº›ä»£ç ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª`testRetainCycle`æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š

**æˆ‘æ˜¯å›¾ç‰‡3**
**æˆ‘æ˜¯å›¾ç‰‡3**

é€šè¿‡åˆ›å»º`ViewController`çš„å®ä¾‹ã€è¿è¡Œ`countIt()`æ–¹æ³•ï¼Œå¹¶æ–­è¨€å®ƒ`numberOfTimes`ä¸º 1 æ¥æµ‹è¯•æ‚¨çš„æ–¹æ³•æ˜¯å¦æœ‰æ•ˆã€‚
```swift
func testRetainCycle() {
    let vc = ViewController()

    vc.countIt()
    XCTAssertEqual(vc.numberOfTimes, 1)
}
```

**é€šè¿‡å•å‡»æ–¹æ³•å·¦ä¾§æ—è¾¹çš„è±å½¢è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•åº”è¯¥æ˜¯é€šè¿‡çš„**

ç°åœ¨ä½ éœ€è¦åšçš„æ˜¯è¯æ˜`vc`åœ¨æµ‹è¯•æ–¹æ³•è¿è¡Œä¹‹ååº”è¯¥ä¸º`nil`ã€‚å› ä¸º`vc`åªåœ¨æµ‹è¯•ä»£ç å—ä¸­æœ‰æ•ˆï¼Œå¦‚æœ`vc`ä¸ä¸º`nil`è¯´æ˜å­˜åœ¨å¾ªç¯å¼•ç”¨ã€‚

åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œç±»`XCTestCase`æœ‰2ä¸ªç‰¹æ®Šæ–¹æ³•`setup()`å’Œ`teardown()`ï¼Œè¿™2ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨æ¯æ¬¡æµ‹è¯•ä¹‹å‰å’Œä¹‹åè°ƒç”¨ã€‚è¦æ£€æŸ¥å¾ªç¯å¼•ç”¨/å†…å­˜æ³„æ¼ï¼Œæ‚¨åªéœ€æ£€æŸ¥æ‚¨çš„å®ä¾‹æ˜¯å¦åœ¨æµ‹è¯•è¿è¡Œåè¢«é‡Šæ”¾ã€‚

> `setup()`ä¸€èˆ¬åˆå§‹åŒ–æµ‹è¯•æ‰€éœ€çš„èµ„æºï¼Œ`teardown()`ä¸€èˆ¬ç”¨äºæµ‹è¯•ç»“æŸé‡Šæ”¾èµ„æº

è™½ç„¶ç±»`XCTestCase`æœ‰ä¸€ä¸ª`teardown()`æ–¹æ³•ï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨`addTearDownBlock(:)`æ–¹æ³•ï¼Œè¿™ä¸ªç‰¹æ®Šçš„æ–¹æ³•ä¼šåœ¨æµ‹è¯•æ–¹æ³•ç»“æŸåï¼Œç±»`XCTestCase`çš„`teardown()`æ–¹æ³•ä¹‹å‰è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨åŒä¸€ä¸ªæµ‹è¯•æ–¹æ³•ä¸­ï¼Œå¯ä»¥å¤šæ¬¡è°ƒç”¨`addTearDownBlock(:)`ï¼Œæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§`LIFO`(last in first out)åŸåˆ™æ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå¯ä»¥åœ¨æ–¹æ³•`setup()`æœŸé—´è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä½†æ˜¯ä¸èƒ½åœ¨`tearDown()`æ–¹æ³•ä¸­è°ƒç”¨æ­¤æ–¹æ³•ã€‚

ç°åœ¨æˆ‘ä»¬åœ¨`addTeardownBlock()`æ–¹æ³•é—­åŒ…ä¸­è¿›è¡Œæ–­è¨€`vc`æ˜¯`nil`ï¼š

```swift
func testRetainCycle() {
    let vc = ViewController()

    vc.countIt()
    XCTAssertEqual(vc.numberOfTimes, 1)

    addTeardownBlock {
        XCTAssertNil(vc)
    }
}
```

è¿è¡Œæµ‹è¯•ï¼Œç»“æœæ˜¯å¤±è´¥çš„ï¼å’Œå…¶ä»–é—­åŒ…ä¸€æ ·ï¼Œè¿™é‡Œ`self`æŒæœ‰`addTeardownBlock`ï¼Œç„¶ååœ¨é—­åŒ…ä¸­æ£€æŸ¥`vc`æ˜¯å¦ä¸º`nil`ï¼Œå¹¶ä¸”`vc`æ˜¯åœ¨é—­åŒ…ä¹‹å‰åˆ›å»ºçš„å±€éƒ¨å˜é‡ï¼ŒæŒ‡å‘å †ç©ºé—´çš„`ViewController`ï¼Œæ‰€ä»¥ç°åœ¨é—­åŒ…å’Œ`vc`é€šè¿‡å±€éƒ¨å˜é‡äº’ç›¸æŒ‡å‘ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ªç¯å¼•ç”¨...

### æ‰“ç ´å¾ªç¯å¼•ç”¨

æˆ‘ä¹‹å‰è¯´è¿‡ï¼Œæ‰“ç ´å¾ªç¯å¼•ç”¨æ˜¯éå¸¸å®¹æ˜“çš„ã€‚Swifté—­åŒ…å¸¦æœ‰æ•è·åˆ—è¡¨ã€‚åœ¨æ•è·åˆ—è¡¨ä¸­ï¼Œæˆ‘ä»¬å£°æ˜è¦åœ¨é—­åŒ…ä¸­ä½¿ç”¨çš„å¤–éƒ¨å¯¹è±¡ï¼Œå¹¶å¯ä»¥æ·»åŠ å±æ€§ä¿®é¥°ç¬¦ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥`weakify`æˆ‘ä»¬çš„`vc`å±æ€§ï¼Œåƒè¿™æ ·ï¼š`addTearDownBlock { [weak vc] in`ã€‚ç”±äºå¼±å¼•ç”¨ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥å°±æ‰“ç ´äº†å¾ªç¯å¼•ç”¨ã€‚

```swift
func testRetainCycle() {
    let vc = ViewController()

    vc.countIt()
    XCTAssertEqual(vc.numberOfTimes, 1)

    addTeardownBlock { [weak vc] in
        XCTAssertNil(vc)
    }
}
```

ä½†æ˜¯å¦‚æœä½ è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œå®ƒä»ç„¶å¤±è´¥ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

å¥½å§ï¼Œæˆ‘ä»¬åªè§£å†³äº†ä¸€ä¸ªå¾ªç¯å¼•ç”¨â€”â€”æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„å•å…ƒæµ‹è¯•ä¸­çš„ä¸€ä¸ªã€‚æˆ‘ä»¬è¿˜è¦å›åˆ°`ViewController`ï¼Œå¹¶åœ¨`countIt()`æ–¹æ³•ä¸­å¼±å¼•ç”¨`self`ï¼Œä½†æ˜¯å½“ä½ è¿™ä¹ˆåšæ—¶ï¼Œä½ åº”è¯¥å¾—åˆ°å‡ ä¸ªç¼–è¯‘å™¨é”™è¯¯ã€‚è¿™æ˜¯å› ä¸º`self`ç°åœ¨æ˜¯`Optional`(å¯é€‰çš„)ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨`unowned`ï¼Œä½†æ˜¯é€šå¸¸ä½¿ç”¨`weak`æ˜¯æ›´å®‰å…¨çš„é€‰æ‹©ã€‚(`unowned`ç±»ä¼¼å¼ºåˆ¶å±•å¼€)

æ‚¨å¯ä»¥éšæ„è§£åŒ…`self`ï¼Œä½†å¦‚æœæ‚¨å¼ºåˆ¶è§£åŒ…ï¼Œé‚£è¿˜ä¸å¦‚ç›´æ¥ä½¿ç”¨`unowned`. è¿™é‡Œæˆ‘é€‰æ‹©å¯â€‹â€‹é€‰é“¾ã€‚ä½†æ˜¯åœ¨è¿™é‡Œï¼Œ`self`æŒæœ‰é—­åŒ…å¹¶ä¸”ä¸æ¶‰åŠå…¶ä»–ç±»ï¼Œæ‰€ä»¥ä½¿ç”¨`unowned`ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚

**æˆ‘æ˜¯å›¾ç‰‡44**
**æˆ‘æ˜¯å›¾ç‰‡44**

```swift
class ViewController: UIViewController {

    var numberOfTimes = 0

    private var closure: (() -> Void) = { }

    init() {
        super.init(nibName: nil, bundle: nil)
        commonInit()
    }

    required init?(coder: NSCoder) {
        super.init(coder: coder)
        commonInit()
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        countIt()
    }

    func commonInit() {
        self.closure = { [weak self] in
            self?.numberOfTimes += 1
            print(self?.numberOfTimes)
        }
    }

    func countIt() {
        closure()
    }
}
```

æœ€åï¼Œå¦‚æœæ‚¨è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œä¼šå‘ç°å¾ªç¯å¼•ç”¨å·²æ–­å¼€ã€‚ç°åœ¨æ‚¨çŸ¥é“äº†åˆ›å»ºå’Œæ–­å¼€å¾ªç¯å¼•ç”¨éƒ½æ˜¯å¤šä¹ˆå®¹æ˜“ã€‚

**æˆ‘æ˜¯å›¾ç‰‡5**
**æˆ‘æ˜¯å›¾ç‰‡5**

### è®©å®ƒå¯é‡å¤ä½¿ç”¨

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»…æµ‹è¯•äº†`vc`ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯å¦‚æœæ‚¨æœ‰å¾ˆå¤šå¼•ç”¨å¯¹è±¡ï¼Œå¹¶ä¸”æƒ³ç¡®ä¿æ²¡æœ‰åœ¨ä»£ç çš„å…¶ä»–åœ°æ–¹é€ æˆå¾ªç¯å¼•ç”¨æ€ä¹ˆåŠï¼Ÿå¤šäºäº†`XCTAssert`çš„ä¸¤ä¸ªå¯é€‰å‚æ•°`file`å’Œ`line`ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å°è£…ä»£ç ï¼Œå¹¶èƒ½è®©é”™è¯¯æç¤ºåˆ°æ­£ç¡®çš„æ–‡ä»¶å’Œè¡Œæ•°ã€‚

åœ¨`testRetainCycle`æ–¹æ³•ä¹‹åï¼Œæ·»åŠ ä¸€ä¸ªå°è£…ä»£ç å¦‚ä¸‹:
```swift
private func assertNoMemoryLeak(_ instance: AnyObject, file: StaticString = #filePath, line: UInt = #line) {
    addTeardownBlock { [weak instance] in
        XCTAssertNil(instance, "âš ï¸å‘ç°æ½œåœ¨çš„å¾ªç¯å¼•ç”¨", file: file, line: line)
    }
}
```

åœ¨éœ€è¦æ£€æµ‹å¾ªç¯çš„åœ°æ–¹ï¼Œç”¨æ­¤æ–¹æ³•æ›¿æ¢`addTearDownBlock`ï¼š
```swift
func testRetainCycle() {
    let vc = ViewController()

    vc.countIt()
    XCTAssertEqual(vc.numberOfTimes, 1)

    assertNoMemoryLeak(vc, file: #filePath, line: #line)
}
```

å‘ç”Ÿå¾ªç¯å¼•ç”¨(å†…å­˜æ³„æ¼)æœ€å¸¸è§çš„åœ°æ–¹ä¹‹ä¸€å°±æ˜¯åœ¨`ViewController`ä½¿ç”¨HTTPç½‘ç»œè¯·æ±‚ã€‚æ‰€ä»¥ä¸‹ä¸€æ­¥ï¼Œæ‚¨å¯ä»¥å°è¯•åœ¨å¼‚æ­¥çš„ç½‘ç»œè¯·æ±‚æ–¹æ³•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå¾ªç¯å¼•ç”¨ï¼Œå¹¶æ‰“ç ´å¾ªç¯å¼•ç”¨ã€‚





